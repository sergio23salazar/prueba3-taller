<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="admin.css">
  <title>Panel de Admin</title>

  <script type="module">
    // --------- IMPORTS FIREBASE ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      remove
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // --------- CONFIG NUEVO PROYECTO ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAthW2iuNy8SGUOVCzhjqEuDOIjWoDpi_A",
      authDomain: "crud-7fb63.firebaseapp.com",
      databaseURL: "https://crud-7fb63-default-rtdb.firebaseio.com",
      projectId: "crud-7fb63",
      storageBucket: "crud-7fb63.firebasestorage.app",
      messagingSenderId: "449296123494",
      appId: "1:449296123494:web:ad23ebf3e3b695ee62cfa7"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    const MIN_STOCK = 20;
    const MAX_STOCK = 100;
    let currentAdminUser = null;


    // --------- PROTECCI√ìN B√ÅSICA DE RUTA (solo admins) ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "../login&registro.html";
        return;
      }

      try {
        const snap = await get(ref(database, `admins/${user.uid}`));
        if (!snap.exists()) {
          alert("No tienes permisos de administrador.");
          window.location.href = "../login&registro.html";
          return;
        }

        // ‚úÖ Es admin, guardamos el usuario actual
        currentAdminUser = user;

        // Si el DOM YA est√° listo, inicializamos de una
        if (document.readyState === "interactive" || document.readyState === "complete") {
          initAdminProfile(currentAdminUser);
        }

      } catch (e) {
        console.error("Error verificando rol de admin:", e);
      }
    });



    // --------- CRUD PRODUCTOS ----------
    function saveProduct(id, name, description, price, stock, discount, promotion) {
      const priceNum = parseFloat(price);
      const stockNum = parseInt(stock, 10);

      if (isNaN(priceNum) || isNaN(stockNum)) {
        alert("Precio y stock deben ser num√©ricos.");
        return;
      }

      if (stockNum < MIN_STOCK) {
        alert(`El stock no puede ser menor a ${MIN_STOCK}.`);
        return;
      }
      if (stockNum > MAX_STOCK) {
        alert(`El stock no puede ser mayor a ${MAX_STOCK}.`);
        return;
      }

      const dbRef = ref(database, "productos/" + id);
      set(dbRef, {
        name,
        description,
        price: priceNum,
        stock: stockNum,
        discount: discount || "",
        promotion: promotion || ""
      }).then(() => {
        alert("Producto guardado correctamente");
        loadProducts();
        clearForm();
      }).catch((error) => {
        console.error("Error al guardar el producto:", error);
      });
    }

    function loadProducts() {
      const dbRef = ref(database, "productos/");
      get(dbRef).then((snapshot) => {
        const productList = snapshot.exists() ? snapshot.val() : {};
        const listContainer = document.getElementById("product-list");
        const lowStockContainer = document.getElementById("low-stock-warning");
        listContainer.innerHTML = "";
        lowStockContainer.innerHTML = "";

        let lowStockAlertHtml = "";
        let totalProducts = 0;
        let lowStockCount = 0;

        for (let id in productList) {
          totalProducts++;
          const product = productList[id];
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>${product.name}</td>
            <td>${product.description}</td>
            <td>${product.price}</td>
            <td>${product.stock}</td>
            <td>${product.discount || "-"}</td>
            <td>${product.promotion || "-"}</td>
            <td class="cell-actions">
              <button class="btn-table" onclick="editProduct('${id}')">Editar</button>
              <button class="btn-table btn-danger" onclick="deleteProduct('${id}')">Eliminar</button>
            </td>
          `;

          listContainer.appendChild(row);

          if (product.stock < MIN_STOCK) {
            lowStockCount++;
            lowStockAlertHtml += `<li>El producto "<strong>${product.name}</strong>" tiene un stock bajo: ${product.stock}</li>`;
          }
        }

        // üëâ actualizar cuadritos de inicio
        const productsCountEl = document.getElementById("products-count");
        if (productsCountEl) productsCountEl.textContent = totalProducts;

        const lowStockCountEl = document.getElementById("low-stock-count");
        if (lowStockCountEl) lowStockCountEl.textContent = lowStockCount;

        if (lowStockAlertHtml) {
          lowStockContainer.innerHTML = `
            <h3>Productos con stock bajo:</h3>
            <ul>${lowStockAlertHtml}</ul>
          `;
        }
      }).catch((error) => {
        console.error("Error al cargar los productos:", error);
      });
    }


    function editProduct(id) {
      const dbRef = ref(database, "productos/" + id);
      get(dbRef).then((snapshot) => {
        const product = snapshot.val();
        document.getElementById("product-id").value = id;
        document.getElementById("product-name").value = product.name;
        document.getElementById("product-description").value = product.description;
        document.getElementById("product-price").value = product.price;
        document.getElementById("product-stock").value = product.stock;

        const discountCheckbox = document.getElementById("discount-checkbox");
        const promotionCheckbox = document.getElementById("promotion-checkbox");
        const discountInput = document.getElementById("product-discount");
        const promotionInput = document.getElementById("product-promotion");

        if (product.discount) {
          discountCheckbox.checked = true;
          discountInput.disabled = false;
          discountInput.value = product.discount;
        } else {
          discountCheckbox.checked = false;
          discountInput.disabled = true;
          discountInput.value = "";
        }

        if (product.promotion) {
          promotionCheckbox.checked = true;
          promotionInput.disabled = false;
          promotionInput.value = product.promotion;
        } else {
          promotionCheckbox.checked = false;
          promotionInput.disabled = true;
          promotionInput.value = "";
        }

      }).catch((error) => {
        console.error("Error al obtener el producto:", error);
      });
    }

    function deleteProduct(id) {
      const dbRef = ref(database, "productos/" + id);
      remove(dbRef).then(() => {
        alert("Producto eliminado");
        loadProducts();
      }).catch((error) => {
        console.error("Error al eliminar el producto:", error);
      });
    }

    function clearForm() {
      const form = document.getElementById("product-form");
      if (form) form.reset();

      const discountInput = document.getElementById("product-discount");
      const promotionInput = document.getElementById("product-promotion");
      const discountCheckbox = document.getElementById("discount-checkbox");
      const promotionCheckbox = document.getElementById("promotion-checkbox");

      discountInput.disabled = true;
      promotionInput.disabled = true;
      discountCheckbox.checked = false;
      promotionCheckbox.checked = false;

      document.getElementById("warning-message").textContent = "";
      document.getElementById("product-id").value = "";
    }

    function handleDiscountPromotionChange() {
      const discountCheckbox = document.getElementById("discount-checkbox");
      const promotionCheckbox = document.getElementById("promotion-checkbox");
      const discountInput = document.getElementById("product-discount");
      const promotionInput = document.getElementById("product-promotion");
      const messageContainer = document.getElementById("warning-message");

      discountInput.disabled = !discountCheckbox.checked;
      promotionInput.disabled = !promotionCheckbox.checked;

      messageContainer.textContent = "";
    }

    // --------- USERS DESDE FIREBASE ----------
// --------- USERS DESDE FIREBASE (empleados / users / usuarios) ----------
function loadUsers() {
  const tbody = document.getElementById("users-table-body");
  const status = document.getElementById("users-status");

  if (!tbody) return;
  tbody.innerHTML = "";
  if (status) status.textContent = "Cargando empleados desde Firebase...";

  const paths = ["empleados/", "users/", "usuarios/"];

  function tryPath(i) {
    if (i >= paths.length) {
      if (status) status.textContent = "No se encontraron empleados en la base de datos.";
      return;
    }

    const path = paths[i];
    const dbRef = ref(database, path);

    get(dbRef)
      .then((snapshot) => {
        if (!snapshot.exists()) {
          tryPath(i + 1);
          return;
        }

        const empleados = snapshot.val();
        tbody.innerHTML = "";

        let count = 0;

        for (let id in empleados) {
          count++;
          const emp = empleados[id];

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${id}</td>
            <td>${emp.nombre || emp.name || "Sin nombre"}</td>
            <td>${emp.email || "Sin correo"}</td>
            <td>Empleado</td>
            <td>${emp.estado || "Activo"}</td>
          `;
          tbody.appendChild(row);
        }

        if (status) {
          status.textContent = `Empleados cargados desde la rama "${path}".`;
        }

        // üëâ actualizar cuadrito de USERS
        const usersCountEl = document.getElementById("users-count");
        if (usersCountEl) usersCountEl.textContent = count;
      })
      .catch((err) => {
        console.error("Error cargando empleados:", err);
        alert("Error al leer empleados en Firebase: " + err.message);
        if (status) status.textContent = "Error al cargar empleados. Revisa las reglas de Firebase.";
      });
  }

  tryPath(0);
}




    // --------- CLIENTES DESDE FIREBASE ----------
// --------- CLIENTES DESDE FIREBASE (clientes / clients) ----------
function loadClients() {
  const tbody = document.getElementById("clients-table-body");
  const status = document.getElementById("clients-status");

  if (!tbody) return;
  tbody.innerHTML = "";
  if (status) status.textContent = "Cargando clientes desde Firebase...";

  const paths = ["clientes/", "clients/"];

  function tryPath(i) {
    if (i >= paths.length) {
      if (status) status.textContent = "No se encontraron clientes en la base de datos.";
      return;
    }

    const path = paths[i];
    const dbRef = ref(database, path);

    get(dbRef)
      .then((snapshot) => {
        if (!snapshot.exists()) {
          tryPath(i + 1);
          return;
        }

        const clients = snapshot.val();
        tbody.innerHTML = "";

        let count = 0;

        for (let id in clients) {
          count++;
          const c = clients[id];

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${id}</td>
            <td>${c.nombre || c.name || "Sin nombre"}</td>
            <td>${c.email || "Sin correo"}</td>
            <td>${c.telefono || c.phone || "Sin tel√©fono"}</td>
            <td>${c.ciudad || c.city || "‚Äî"}</td>
          `;
          tbody.appendChild(row);
        }

        if (status) {
          status.textContent = `Clientes cargados desde la rama "${path}".`;
        }

        // üëâ actualizar cuadrito de CLIENT
        const clientsCountEl = document.getElementById("clients-count");
        if (clientsCountEl) clientsCountEl.textContent = count;
      })
      .catch((err) => {
        console.error("Error cargando clientes:", err);
        alert("Error al leer clientes en Firebase: " + err.message);
        if (status) status.textContent = "Error al cargar clientes. Revisa las reglas de Firebase.";
      });
  }

  tryPath(0);
}


function applyTheme(theme) {
  const body = document.body;
  if (!body) return;

  body.classList.remove("theme-dark", "theme-light");

  if (theme === "claro") {
    body.classList.add("theme-light");
  } else {
    body.classList.add("theme-dark");
  }
}

function initAdminProfile(user) {
  const nameInput = document.getElementById("admin-name");
  const emailInput = document.getElementById("admin-email");
  const avatarInput = document.getElementById("admin-avatar");
  const themeSelect = document.getElementById("admin-theme");
  const sidebarName = document.getElementById("sidebar-name");
  const sidebarAvatar = document.getElementById("sidebar-avatar");
  const saveBtn = document.getElementById("admin-profile-save-btn");

  if (!nameInput || !emailInput || !avatarInput || !themeSelect || !saveBtn) {
    return; // por si la vista a√∫n no est√° renderizada
  }

  const uid = user.uid;
  const storageKey = `adminProfile_${uid}`;

  // Leer perfil guardado (si existe)
  let saved = null;
  try {
    const raw = localStorage.getItem(storageKey);
    if (raw) saved = JSON.parse(raw);
  } catch (e) {
    console.error("Error leyendo perfil de admin:", e);
  }

  // Correo desde Firebase Auth
  const email = user.email || (saved && saved.email) || "";
  emailInput.value = email;

  // Nombre: guardado, o derivado del correo, o "Admin"
  let name = (saved && saved.name) || "";
  if (!name) {
    if (email) {
      name = email.split("@")[0];
      name = name.charAt(0).toUpperCase() + name.slice(1);
    } else {
      name = "Admin";
    }
  }
  nameInput.value = name;
  if (sidebarName) sidebarName.textContent = name;

  // Avatar: si hay URL guardada, usarla; si no, inicial por letra
  const avatarUrl = (saved && saved.avatarUrl) || "";
  avatarInput.value = avatarUrl;

  if (sidebarAvatar) {
    if (avatarUrl) {
      sidebarAvatar.style.backgroundImage = `url('${avatarUrl}')`;
      sidebarAvatar.style.backgroundSize = "cover";
      sidebarAvatar.style.backgroundPosition = "center";
      sidebarAvatar.textContent = "";
    } else {
      sidebarAvatar.style.backgroundImage = "";
      sidebarAvatar.textContent = name.charAt(0).toUpperCase();
    }
  }

  // Tema
  const theme = (saved && saved.theme) || "oscuro";
  themeSelect.value = theme;
  applyTheme(theme);

  // Guardar cambios al hacer clic
  saveBtn.onclick = () => {
    const newName = nameInput.value.trim() || name;
    const newAvatar = avatarInput.value.trim();
    const newTheme = themeSelect.value || "oscuro";

    const profile = {
      name: newName,
      email: emailInput.value || email,
      avatarUrl: newAvatar,
      theme: newTheme
    };

    try {
      localStorage.setItem(storageKey, JSON.stringify(profile));
      alert("Perfil de administrador guardado.");
    } catch (e) {
      console.error("Error guardando perfil de admin:", e);
    }

    // Actualizar sidebar
    if (sidebarName) sidebarName.textContent = newName;

    if (sidebarAvatar) {
      if (newAvatar) {
        sidebarAvatar.style.backgroundImage = `url('${newAvatar}')`;
        sidebarAvatar.style.backgroundSize = "cover";
        sidebarAvatar.style.backgroundPosition = "center";
        sidebarAvatar.textContent = "";
      } else {
        sidebarAvatar.style.backgroundImage = "";
        sidebarAvatar.textContent = newName.charAt(0).toUpperCase();
      }
    }

    applyTheme(newTheme);
  };
}




    // --------- NOTIFICACIONES STOCK BAJO ----------
    function showLowStockNotifications() {
      const dbRef = ref(database, "productos/");
      get(dbRef).then((snapshot) => {
        const productList = snapshot.exists() ? snapshot.val() : {};
        const lowStockProducts = [];

        for (let id in productList) {
          const product = productList[id];
          if (product.stock < MIN_STOCK) {
            lowStockProducts.push(product);
          }
        }

        const prev = document.querySelector(".notification-window");
        if (prev) prev.remove();

        if (lowStockProducts.length > 0) {
          const notificationWindow = document.createElement("div");
          notificationWindow.classList.add("notification-window");
          notificationWindow.innerHTML = `
            <h2>Productos con Stock Bajo</h2>
            <div id="notification-options">
              <label>Notificaciones:</label>
            </div>
            <ul>
              ${lowStockProducts
                .map(
                  (product) =>
                    `<li>El producto "<strong>${product.name}</strong>" tiene un stock de ${product.stock}</li>`
                )
                .join("")}
            </ul>
            <button onclick="closeNotificationWindow()">Cerrar</button>
          `;
          document.body.appendChild(notificationWindow);
        } else {
          alert("No hay productos con stock bajo.");
        }
      }).catch((error) => {
        console.error("Error al cargar los productos:", error);
      });
    }

    function closeNotificationWindow() {
      const notificationWindow = document.querySelector(".notification-window");
      if (notificationWindow) notificationWindow.remove();
    }

    function logout() {
      signOut(auth)
        .then(() => {
          window.location.href = "../login&registro.html";
        })
        .catch((err) => {
          console.error("Error al cerrar sesi√≥n:", err);
          window.location.href = "../login&registro.html";
        });
    }

    // Exponer funciones necesarias
    window.saveProduct = saveProduct;
    window.loadProducts = loadProducts;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.handleDiscountPromotionChange = handleDiscountPromotionChange;
    window.showLowStockNotifications = showLowStockNotifications;
    window.closeNotificationWindow = closeNotificationWindow;
    window.logout = logout;
    window.loadUsers = loadUsers;
    window.loadClients = loadClients;


    // Inicializar cuando cargue el DOM
    window.addEventListener("DOMContentLoaded", () => {
      loadProducts();
      loadUsers();
      loadClients();

      // üëá Si ya tenemos al admin desde onAuthStateChanged, rellenamos el perfil
      if (currentAdminUser) {
        initAdminProfile(currentAdminUser);
      }

      const form = document.getElementById("product-form");
      if (form) {
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const id = document.getElementById("product-id").value || Date.now().toString();
          const name = document.getElementById("product-name").value;
          const description = document.getElementById("product-description").value;
          const price = document.getElementById("product-price").value;
          const stock = document.getElementById("product-stock").value;
          const discount = document.getElementById("product-discount").value;
          const promotion = document.getElementById("product-promotion").value;

          saveProduct(id, name, description, price, stock, discount, promotion);
        });
      }
    });
  </script>
</head>

<body>
  <div class="dashboard">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="avatar-circle" id="sidebar-avatar">A</div>
        <div class="user-info">
          <p class="user-name" id="sidebar-name">Admin</p>
          <p class="user-role">Panel de control</p>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-view="inicio">
          <span class="nav-icon">üè†</span><span>Inicio</span>
        </a>
        <a href="#" class="nav-item" data-view="admin">
          <span class="nav-icon">üßë‚Äçüíª</span><span>Admin</span>
        </a>
        <a href="#" class="nav-item" data-view="users">
          <span class="nav-icon">üë•</span><span>Users</span>
        </a>
        <a href="#" class="nav-item" data-view="clients">
          <span class="nav-icon">üßæ</span><span>Client</span>
        </a>
        <a href="#" class="nav-item" data-view="tables">
          <span class="nav-icon">üìä</span><span>Tables</span>
        </a>
        <a href="#" class="nav-item" data-view="notifications">
          <span class="nav-icon">üîî</span><span>Notification</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <small>¬© 2025 Muebles Concepci√≥n a Medida</small>
      </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content">
      <header class="main-header">
        <div>
          <h1 class="page-title">Administraci√≥n</h1>
          <p class="page-subtitle">Gestiona productos, stock y reportes de ventas.</p>
        </div>

        <div class="top-bar">
          <!-- <button class="center-button" onclick="showLowStockNotifications()" title="Ver productos con stock bajo">
            <img src="notification3.png" alt="Notificaci√≥n" class="img">
          </button> -->
          <!-- <button class="btn-config" onclick="openPopup()">Config</button> -->
          <button class="btn-login" onclick="window.location.href='../index.html'">Inicio</button>
          <button class="btn-login" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
      </header>

      <!-- ===== INICIO ===== -->
      <div id="view-inicio" class="view active-view">
        <section class="section">
          <div class="summary-grid">
            <div class="summary-card">
              <h3>ADMIN</h3>
              <p class="summary-number" id="admin-count">1</p>
              <span class="summary-label">Administrador activo</span>
            </div>
            <div class="summary-card">
              <h3>USERS</h3>
              <p class="summary-number" id="users-count">0</p>
              <span class="summary-label">Empleados registrados</span>
            </div>
            <div class="summary-card">
              <h3>CLIENT</h3>
              <p class="summary-number" id="clients-count">0</p>
              <span class="summary-label">Clientes registrados</span>
            </div>
            <div class="summary-card">
              <h3>TABLES</h3>
              <p class="summary-number" id="products-count">0</p>
              <span class="summary-label">Productos en Firebase</span>
            </div>
            <div class="summary-card">
              <h3>NOTIFICATION</h3>
              <p class="summary-number" id="low-stock-count">0</p>
              <span class="summary-label">Productos en stock cr√≠tico</span>
            </div>
          </div>
        </section>

        <section class="section">
          <div class="card calendar-card">
            <div class="calendar-header">
              <button id="prev-month" class="calendar-nav-btn">‚Äπ</button>
              <div class="calendar-title">
                <span id="calendar-month">Septiembre</span>
                <span id="calendar-year">2024</span>
              </div>
              <button id="next-month" class="calendar-nav-btn">‚Ä∫</button>
            </div>
            <p class="calendar-today-label">
              Hoy: <span id="today-label" class="today-date"></span>
            </p>
            <table class="calendar-table">
              <thead>
                <tr>
                  <th>Lun</th>
                  <th>Mar</th>
                  <th>Mi√©</th>
                  <th>Jue</th>
                  <th>Vie</th>
                  <th>S√°b</th>
                  <th>Dom</th>
                </tr>
              </thead>
              <tbody id="calendar-body"></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- ===== ADMIN PERFIL ===== -->
      <div id="view-admin" class="view">
        <section class="section">
          <div class="card">
            <h2>Perfil de administrador</h2>
            <p class="section-description">
              Configuraci√≥n b√°sica de tu perfil. <!-- (ejemplo visual, sin conexi√≥n a√∫n a Firebase). -->
            </p>

            <form id="admin-profile-form">
              <label>Nombre</label>
              <input type="text" id="admin-name" placeholder="Nombre del administrador">

              <label>Correo</label>
              <input type="email" id="admin-email" placeholder="admin@correo.com" readonly>

              <label>Avatar (URL de imagen)</label>
              <input type="text" id="admin-avatar" placeholder="https://...">

              <label>Tema</label>
              <select id="admin-theme">
                <option value="oscuro">Oscuro (actual)</option>
                <option value="claro">Claro</option>
              </select>

              <button type="button" id="admin-profile-save-btn">
                Guardar cambios
              </button>
            </form>
          </div>
        </section>
      </div>

      <!-- ===== USERS ===== -->
      <div id="view-users" class="view">
        <section class="section">
          <div class="card">
            <h2>Usuarios del sistema</h2>
            <p class="section-description">
              Se muestran los usuarios registrados en la base de datos (rama "users").
            </p>
            <p id="users-status" class="section-description"></p>


            <div class="table-wrapper">
              <table class="product-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Rol</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody id="users-table-body">
                  <!-- filas desde Firebase -->
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <!-- ===== CLIENTES ===== -->
      <div id="view-clients" class="view">
        <section class="section">
          <div class="card">
            <h2>Clientes</h2>
            <p class="section-description">
              Lista de clientes desde Firebase (rama "clients" o "clientes").
            </p>
            <p id="clients-status" class="section-description"></p>

            <div class="table-wrapper">
              <table class="product-table">
                <thead>
                  <tr>
                    <th>RUT / ID</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Tel√©fono</th>
                    <th>Ciudad</th>
                  </tr>
                </thead>
                <tbody id="clients-table-body">
                  <!-- filas desde Firebase -->
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <!-- ===== TABLES (PRODUCTOS) ===== -->
      <div id="view-tables" class="view">
        <section class="section">
          <h2>Productos</h2>
          <p class="section-description">
            Aqu√≠ puedes registrar productos, actualizar el stock y ver los que est√°n en nivel cr√≠tico.
          </p>

          <div class="two-column">
            <div class="card">
              <h3>Nuevo / Editar producto</h3>
              <form id="product-form">
                <input type="hidden" id="product-id" />

                <input type="text" id="product-name" placeholder="Nombre" required />
                <textarea id="product-description" placeholder="Descripci√≥n" required></textarea>
                <input type="number" id="product-price" placeholder="Precio" required />
                <input type="number" id="product-stock" placeholder="Stock" required />

                <div class="checkbox-container">
                  <div>
                    <input type="checkbox" id="discount-checkbox" onclick="handleDiscountPromotionChange()">
                    <label for="discount-checkbox">Descuento</label>
                  </div>
                  <div>
                    <input type="checkbox" id="promotion-checkbox" onclick="handleDiscountPromotionChange()">
                    <label for="promotion-checkbox">Promoci√≥n</label>
                  </div>
                </div>

                <div>
                  <input type="number" id="product-discount" placeholder="Descuento (%)" disabled />
                </div>

                <div>
                  <input type="text" id="product-promotion" placeholder="Promoci√≥n" disabled />
                </div>

                <div id="warning-message"></div>

                <button type="submit">Guardar Producto</button>
              </form>
            </div>

            <div class="card">
              <div class="tables-header">
                <h3>Lista de productos</h3>
                <input type="text" id="product-search" placeholder="Buscar por nombre o descripci√≥n">
              </div>

              <div class="table-wrapper">
                <table class="product-table">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Descripci√≥n</th>
                      <th>Precio</th>
                      <th>Stock</th>
                      <th>Desc. (%)</th>
                      <th>Promoci√≥n</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="product-list">
                    <!-- Filas generadas con Firebase -->
                  </tbody>
                </table>
              </div>

              <div id="low-stock-warning"></div>
            </div>
          </div>
        </section>

        <section class="section">
          <div class="card">
            <h2>Generar Informe de Ventas</h2>
            <p class="section-description">
              Genera reportes entre rangos de fechas en PDF o Excel.
            </p>
            <form id="reportForm">
              <label for="startDate">Fecha de Inicio:</label>
              <input type="date" id="startDate" name="startDate" required>

              <label for="endDate">Fecha de Fin:</label>
              <input type="date" id="endDate" name="endDate" required>

              <label for="format">Formato:</label>
              <select id="format" name="format" required>
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
              </select>

              <button type="submit">Generar Informe</button>
            </form>
          </div>
        </section>
      </div>

      <!-- ===== NOTIFICATIONS ===== -->
      <div id="view-notifications" class="view">
        <section class="section">
          <div class="card">
            <div class="notifications-header">
              <h2>Centro de notificaciones</h2>
              <button class="close-x" onclick="closeNotificationsView()">‚úï</button>
            </div>
            <p class="section-description">
              Configura las alertas de stock bajo y revisa r√°pidamente qu√© productos est√°n en nivel cr√≠tico.
            </p>
            <button type="button" class="btn-outline" onclick="openPopup()">Configurar notificaciones</button>
            <button type="button" class="btn-outline" onclick="showLowStockNotifications()">Ver productos con stock bajo</button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- POPUP CONFIG NOTIFICACIONES -->
  <div class="popup-overlay" id="popupOverlay"></div>

  <div class="popup" id="popup">
    <button class="close-btn" onclick="closePopup()">√ó</button>
    <h2>Configuraci√≥n de Notificaciones</h2>
    <form id="notificationSettingsForm">
      <label>
        <input type="checkbox" id="enableNotifications" checked>
        Activar Notificaciones
      </label><br><br>

      <label>
        Frecuencia de Notificaciones:
        <select id="notificationFrequency">
          <option value="daily">Diarias</option>
          <option value="weekly">Semanales</option>
          <option value="monthly">Mensuales</option>
        </select>
      </label><br><br>

      <label>
        Estilo de Notificaci√≥n:
        <select id="notificationStyle">
          <option value="banner">Banner</option>
          <option value="popup">Ventana Emergente</option>
          <option value="email">Correo Electr√≥nico</option>
        </select>
      </label><br><br>

      <button type="button" onclick="saveSettings()">Guardar Configuraci√≥n</button>
    </form>
    <br>
    <!-- <button type="button" onclick="showLowStockNotifications()">Ver Notificaciones de Stock Bajo</button> -->
  </div>

  <!-- POPUP (simple) -->
  <script>
    function openPopup() {
      document.getElementById("popup").classList.add("open");
      document.getElementById("popupOverlay").classList.add("open");
    }

    function closePopup() {
      document.getElementById("popup").classList.remove("open");
      document.getElementById("popupOverlay").classList.remove("open");
    }

    function saveSettings() {
      const enableNotifications = document.getElementById("enableNotifications").checked;
      const notificationFrequency = document.getElementById("notificationFrequency").value;
      const notificationStyle = document.getElementById("notificationStyle").value;

      alert(
`Configuraci√≥n guardada:
Notificaciones: ${enableNotifications ? "Activadas" : "Desactivadas"}
Frecuencia: ${notificationFrequency}
Estilo: ${notificationStyle}`
      );

      closePopup();
    }
  </script>

  <!-- Reportes -->
  <script>
    document.getElementById("reportForm").addEventListener("submit", function(event) {
      event.preventDefault();
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const format = document.getElementById("format").value;

      fetch("/generate-report", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ startDate, endDate, format })
      })
        .then(response => response.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = url;
          a.download = `report.${format === "pdf" ? "pdf" : "xlsx"}`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error("Error:", error));
    });
  </script>

  <!-- Navegaci√≥n de vistas + calendario tipo app + buscador -->
  <script>
    function closeNotificationsView() {
      const inicioNav = document.querySelector('.nav-item[data-view="inicio"]');
      if (inicioNav) inicioNav.click();
    }
    window.closeNotificationsView = closeNotificationsView;

    const monthNames = [
      "Enero","Febrero","Marzo","Abril","Mayo","Junio",
      "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
    ];

    let currentDate = new Date();
    const today = new Date();

    function renderCalendar() {
      const body = document.getElementById("calendar-body");
      const monthLabel = document.getElementById("calendar-month");
      const yearLabel = document.getElementById("calendar-year");
      if (!body || !monthLabel || !yearLabel) return;

      body.innerHTML = "";

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      monthLabel.textContent = monthNames[month];
      yearLabel.textContent = year;

      const firstDay = new Date(year, month, 1);
      let startDay = (firstDay.getDay() + 6) % 7; // lunes = 0

      const daysInMonth = new Date(year, month + 1, 0).getDate();

      let day = 1 - startDay;

      for (let week = 0; week < 6; week++) {
        const tr = document.createElement("tr");

        for (let i = 0; i < 7; i++) {
          const td = document.createElement("td");
          const date = new Date(year, month, day);

          td.textContent = date.getDate();
          td.classList.add("calendar-day");

          if (date.getMonth() !== month) {
            td.classList.add("other-month");
          }

          if (
            date.getDate() === today.getDate() &&
            date.getMonth() === today.getMonth() &&
            date.getFullYear() === today.getFullYear()
          ) {
            td.classList.add("today");
          }

          tr.appendChild(td);
          day++;
        }

        body.appendChild(tr);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      // Nav de vistas
      const navItems = document.querySelectorAll(".nav-item");
      const views = document.querySelectorAll(".view");

      navItems.forEach(item => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const target = item.dataset.view;
          if (!target) return;

          navItems.forEach(i => i.classList.remove("active"));
          item.classList.add("active");

          views.forEach(v => {
            if (v.id === "view-" + target) {
              v.classList.add("active-view");
            } else {
              v.classList.remove("active-view");
            }
          });
        });
      });

      // Calendario
      const todayLabel = document.getElementById("today-label");
      if (todayLabel) {
        const options = { weekday: "long", day: "numeric", month: "long", year: "numeric" };
        todayLabel.textContent = today.toLocaleDateString("es-CL", options);
      }

      const prevBtn = document.getElementById("prev-month");
      const nextBtn = document.getElementById("next-month");

      if (prevBtn) {
        prevBtn.addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar();
        });
      }
      if (nextBtn) {
        nextBtn.addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar();
        });
      }

      renderCalendar();

      // Buscador productos
      const searchInput = document.getElementById("product-search");
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          const filter = searchInput.value.toLowerCase();
          const rows = document.querySelectorAll("#product-list tr");
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? "" : "none";
          });
        });
      }
    });
  </script>
</body>
</html>
