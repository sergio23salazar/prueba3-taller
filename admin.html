<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles2.css">
  <title>Panel de Admin</title>
  <script type="module">
    // Configuración de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGagpgCaZPtv3rrQVpiPLSUJzI3sJogGg",
      authDomain: "crud-18998.firebaseapp.com",
      projectId: "crud-18998",
      storageBucket: "crud-18998.firebasestorage.app",
      messagingSenderId: "1046471634199",
      appId: "1:1046471634199:web:37309d7fd8825896755b52"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const MIN_STOCK = 20; // Stock mínimo
    const MAX_STOCK = 100; // Stock máximo

    // Función para guardar o actualizar un producto
    function saveProduct(id, name, description, price, stock, discount, promotion) {
      // Validaciones de stock
      if (stock < MIN_STOCK) {
        alert(`El stock no puede ser menor a ${MIN_STOCK}.`);
        return;
      }
      if (stock > MAX_STOCK) {
        alert(`El stock no puede ser mayor a ${MAX_STOCK}.`);
        return;
      }

      const dbRef = ref(database, 'productos/' + id);
      set(dbRef, {
        name: name,
        description: description,
        price: price,
        stock: stock,
        discount: discount,  // Guardamos el descuento
        promotion: promotion // Guardamos la promoción
      }).then(() => {
        alert('Producto guardado correctamente');
        loadProducts();
        clearForm();
      }).catch((error) => {
        console.error('Error al guardar el producto:', error);
      });
    }

// Función para cargar todos los productos
function loadProducts() {
  const dbRef = ref(database, 'productos/');
  get(dbRef).then((snapshot) => {
    const productList = snapshot.exists() ? snapshot.val() : {};
    const listContainer = document.getElementById('product-list');
    const lowStockContainer = document.getElementById('low-stock-warning');
    listContainer.innerHTML = '';
    lowStockContainer.innerHTML = '';

    let lowStockAlert = '';
    

    // Iteramos sobre los productos cargados
    for (let id in productList) {
      const product = productList[id];
      const listItem = document.createElement('li');
      let discountText = product.discount ? ` - Descuento: ${product.discount}%` : '';
      let promotionText = product.promotion ? ` - Promoción: ${product.promotion}` : '';

      // Agregamos los productos a la lista
      listItem.innerHTML = `
        <div class="product-info">
          <strong>Nombre:</strong> ${product.name}<br>
          <strong>Descripción:</strong> ${product.description}<br>
          <strong>Precio:</strong> ${product.price}<br>
          <strong>Stock:</strong> ${product.stock}<br>
          ${discountText} ${promotionText}
        </div>
        <div class="button-container">
          <button onclick="editProduct('${id}')">Editar</button>
          <button onclick="deleteProduct('${id}')">Eliminar</button>
        </div>`;
      listContainer.appendChild(listItem);

      // Alertamos si el stock es bajo
      if (product.stock < MIN_STOCK) {
        lowStockAlert += `<li>El producto "${product.name}" tiene un stock bajo: ${product.stock}</li>`;
      }
    }

    if (lowStockAlert) {
      lowStockContainer.innerHTML = `
        <h3>Productos con stock bajo:</h3>
        <ul>${lowStockAlert}</ul>
      `;
    }
  }).catch((error) => {
    console.error('Error al cargar los productos:', error);
  });
}

// Función para mostrar notificaciones de productos con stock bajo
function showLowStockNotifications() {
  const dbRef = ref(database, 'productos/');
  get(dbRef).then((snapshot) => {
    const productList = snapshot.exists() ? snapshot.val() : {};
    const lowStockProducts = [];

    // Iteramos sobre los productos cargados
    for (let id in productList) {
      const product = productList[id];
      if (product.stock < MIN_STOCK) {
        lowStockProducts.push(product);
      }
    }

    // Mostramos las notificaciones en una ventana emergente
    if (lowStockProducts.length > 0) {
      const notificationWindow = document.createElement('div');
      notificationWindow.innerHTML = `
        <h2>Notificaciones de Productos con Stock Bajo</h2>
        <ul>
          ${lowStockProducts.map((product) => `<li>El producto "${product.name}" tiene un stock bajo: ${product.stock}</li>`).join('')}
        </ul>
        <button onclick="closeNotificationWindow()">Cerrar</button>
      `;
      notificationWindow.classList.add('notification-window');
      document.body.appendChild(notificationWindow);
    }
  }).catch((error) => {
    console.error('Error al cargar los productos:', error);
  });
}
window.showLowStockNotifications = showLowStockNotifications;
window.closeNotificationWindow = closeNotificationWindow;
// Función para cerrar la ventana emergente de notificaciones
function closeNotificationWindow() {
  const notificationWindow = document.querySelector('.notification-window');
  if (notificationWindow) {
    notificationWindow.remove();
  }
}
    // Función para editar un producto
    function editProduct(id) {
      const dbRef = ref(database, 'productos/' + id);
      get(dbRef).then((snapshot) => {
        const product = snapshot.val();
        document.getElementById('product-id').value = id;
        document.getElementById('product-name').value = product.name;
        document.getElementById('product-description').value = product.description;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-stock').value = product.stock;
        document.getElementById('product-discount').value = product.discount || ''; // Mostrar descuento si lo tiene
        document.getElementById('product-promotion').value = product.promotion || ''; // Mostrar promoción si la tiene
      });
    }

    // Función para eliminar un producto
    function deleteProduct(id) {
      const dbRef = ref(database, 'productos/' + id);
      remove(dbRef).then(() => {
        alert('Producto eliminado');
        loadProducts();
      }).catch((error) => {
        console.error('Error al eliminar el producto:', error);
      });
    }

    // Función para limpiar el formulario
    function clearForm() {
      document.getElementById('product-form').reset();
      // Resetear los campos de descuento y promoción
      document.getElementById('product-discount').disabled = true;
      document.getElementById('product-promotion').disabled = true;
    }

    // Función para manejar la selección de descuento o promoción
    function handleDiscountPromotionChange() {
      const discountCheckbox = document.getElementById('discount-checkbox');
      const promotionCheckbox = document.getElementById('promotion-checkbox');
      const messageContainer = document.getElementById('warning-message');

      // Habilitar/deshabilitar los campos según las casillas
      document.getElementById('product-discount').disabled = !discountCheckbox.checked;
      document.getElementById('product-promotion').disabled = !promotionCheckbox.checked;

      // Mostrar mensaje de advertencia si no se marca una casilla
      if (!discountCheckbox.checked && document.getElementById('product-discount').value !== '') {
        messageContainer.textContent = 'Por favor, marque la casilla de "Descuento" antes de ingresar un valor.';
        messageContainer.style.color = 'red';
      } else if (!promotionCheckbox.checked && document.getElementById('product-promotion').value !== '') {
        messageContainer.textContent = 'Por favor, marque la casilla de "Promoción" antes de ingresar un valor.';
        messageContainer.style.color = 'red';
      } else {
        messageContainer.textContent = ''; // Limpiar el mensaje si no hay errores
      }

      if (!discountCheckbox.checked) {
        document.getElementById('product-discount').value = ''; // Limpiar el campo de descuento
      }
      if (!promotionCheckbox.checked) {
        document.getElementById('product-promotion').value = ''; // Limpiar el campo de promoción
      }
    }

    window.saveProduct = saveProduct;
    window.loadProducts = loadProducts;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.handleDiscountPromotionChange = handleDiscountPromotionChange;

    window.onload = loadProducts;

    // Guardar un producto cuando se envíe el formulario
    document.getElementById('product-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('product-id').value || Date.now().toString();
      const name = document.getElementById('product-name').value;
      const description = document.getElementById('product-description').value;
      const price = document.getElementById('product-price').value;
      const stock = document.getElementById('product-stock').value;
      const discount = document.getElementById('product-discount').value;
      const promotion = document.getElementById('product-promotion').value;
      saveProduct(id, name, description, price, stock, discount, promotion);
    });
  </script>

  <style>
    /* Estilos para el formulario */
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 300px;
      margin: 0 auto;
    }

    .button-container {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    /* Estilos para los botones de descuento y promoción */
    input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.5);
    }

    label {
      font-size: 16px;
      font-weight: bold;
    }

    .checkbox-group {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    #warning-message {
      font-size: 14px;
      margin-top: 10px;
    }

    /* Estilos para el formulario de descuento y promoción */
    .checkbox-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .checkbox-container div {
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>

</head>
<body>
  <h1>Panel de Admin</h1>
  <h2>CRUD de Productos</h2>


  <!-- Formulario para agregar o editar un producto -->
  <form id="product-form">
    <button class="center-button" onclick="showLowStockNotifications()"> <img src="notification3.png" alt="Notificación" class="img"> </button>    <input type="hidden" id="product-id" />
    <button onclick="window.location.href='../index.html'">Volver a Inicio</button>
    <button onclick="window.location.href='../login&registro.html'">Cerrar Sesión</button>
    <input type="text" id="product-name" placeholder="Nombre" required/>
    <textarea id="product-description" placeholder="Descripción" required></textarea>
    <input type="number" id="product-price" placeholder="Precio" required />
    <input type="number" id="product-stock" placeholder="Stock" required />

    <!-- Opciones para seleccionar descuento y/o promoción -->
    <div class="checkbox-container">
      <div>
        <input type="checkbox" id="discount-checkbox" onclick="handleDiscountPromotionChange()">
        <label for="discount-checkbox">Descuento</label>
      </div>
      <div>
        <input type="checkbox" id="promotion-checkbox" onclick="handleDiscountPromotionChange()">
        <label for="promotion-checkbox">Promoción</label>
      </div>
    </div>

    <!-- Campo de descuento -->
    <div>
      <input type="number" id="product-discount" placeholder="Descuento (%)" disabled />
    </div>

    <!-- Campo de promoción -->
    <div>
      <input type="text" id="product-promotion" placeholder="Promoción" disabled />
    </div>

    <!-- Mensaje de advertencia -->
    <div id="warning-message"></div>

    <button type="submit">Guardar Producto</button>
  </form>

  <h2>Lista de Productos</h2>
  <ul id="product-list"></ul>

  <div id="low-stock-warning"></div>
</body>
</html>
