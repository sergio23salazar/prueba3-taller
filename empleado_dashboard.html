<!DOCTYPE html> 
<html lang="es"> 
<head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <link rel="stylesheet" href="styles2.css"> 
  <link rel="stylesheet" href="admin.css"> 
 
  <title>Panel de Empleado</title> 
 
  <script type="module"> 
    // Firebase imports 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"; 
    import { 
      getDatabase, 
      ref, 
      get, 
      update, 
      set 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js"; 
    import {
      getAuth,
      onAuthStateChanged,
      signOut 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js"; 
 
    const firebaseConfig = { 
      apiKey: "AIzaSyAthW2iuNy8SGUOVCzhjqEuDOIjWoDpi_A",
      authDomain: "crud-7fb63.firebaseapp.com", 
      databaseURL: "https://crud-7fb63-default-rtdb.firebaseio.com", 
      projectId: "crud-7fb63", 
      storageBucket: "crud-7fb63.firebasestorage.app",
      messagingSenderId: "449296123494",
      appId: "1:449296123494:web:ad23ebf3e3b695ee62cfa7"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    let cart = [];
    let allProducts = {};
    let currentSearch = "";
    let currentSort = "default";

    // Protecci√≥n de ruta
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "../login&registro.html";
        return;
      }

      try {
        const empleadoSnap = await get(ref(database, `empleados/${user.uid}`));
        const adminSnap   = await get(ref(database, `admins/${user.uid}`));

        if (!empleadoSnap.exists() && !adminSnap.exists()) {
          alert("No tienes permisos para acceder al panel de empleado.");
          window.location.href = "../login&registro.html";
          return;
        }

        const sidebarName = document.getElementById("sidebar-name");
        const sidebarAvatar = document.getElementById("sidebar-avatar");
        const email = user.email || "";
        let name = email ? email.split("@")[0] : "Empleado";
        name = name.charAt(0).toUpperCase() + name.slice(1);

        if (sidebarName) sidebarName.textContent = name;
        if (sidebarAvatar) sidebarAvatar.textContent = name.charAt(0).toUpperCase();
      } catch (e) {
        console.error("Error verificando rol del usuario:", e);
      }
    });

    // Cargar productos
    function loadProducts() {
      const dbRef = ref(database, "productos/");
      get(dbRef)
        .then((snapshot) => {
          allProducts = snapshot.exists() ? snapshot.val() : {};
          renderProducts();

          const productsCountEl = document.getElementById("products-count");
          if (productsCountEl) {
            productsCountEl.textContent = Object.keys(allProducts).length;
          }
        })
        .catch((error) => {
          console.error("Error al cargar los productos:", error);
        });
    }

    // Renderizar productos con filtros/orden
    function renderProducts() {
      const listContainer = document.getElementById("product-list");
      if (!listContainer) return;
      listContainer.innerHTML = "";

      let entries = Object.entries(allProducts);

      if (currentSearch.trim() !== "") {
        const term = currentSearch.toLowerCase();
        entries = entries.filter(([id, p]) => {
          const name = (p.name || "").toLowerCase();
          const desc = (p.description || "").toLowerCase();
          return name.includes(term) || desc.includes(term);
        });
      }

      entries.sort((a, b) => {
        const pa = a[1];
        const pb = b[1];
        switch (currentSort) {
          case "stock-desc":
            return (pb.stock || 0) - (pa.stock || 0);
          case "stock-asc":
            return (pa.stock || 0) - (pb.stock || 0);
          case "name-asc":
            return (pa.name || "").localeCompare(pb.name || "");
          case "name-desc":
            return (pb.name || "").localeCompare(pa.name || "");
          default:
            return 0;
        }
      });

      for (const [id, product] of entries) {
        const li = document.createElement("li");
        li.id = `product-${id}`;
        li.classList.add("product-list-item");

        li.innerHTML = `
          <div class="product-info">
            <div class="product-main-row">
              <span class="product-name">${product.name}</span>
              <span class="product-price">$${product.price}</span>
            </div>
            <p class="product-description">${product.description}</p>
            <div class="product-meta-row">
              <span><strong>Stock:</strong> <span id="stock-${id}">${product.stock}</span></span>
              <span class="product-qty">
                <label for="quantity-${id}">Cantidad:</label>
                <input type="number" id="quantity-${id}" min="1" max="${product.stock}" value="1">
              </span>
            </div>
          </div>
          <div class="button-container">
            <button type="button" onclick="addToCart('${id}')">Agregar</button>
          </div>
        `;
        listContainer.appendChild(li);
      }

      if (entries.length === 0) {
        const empty = document.createElement("p");
        empty.classList.add("section-description");
        empty.textContent = "No se encontraron productos con los filtros actuales.";
        listContainer.appendChild(empty);
      }
    }

    // Agregar al carrito
    function addToCart(id) {
      const quantityInput = document.getElementById(`quantity-${id}`);
      const quantity = parseInt(quantityInput.value, 10);

      if (isNaN(quantity) || quantity <= 0) {
        alert("Por favor, ingrese una cantidad v√°lida.");
        return;
      }

      const dbRef = ref(database, "productos/" + id);
      get(dbRef).then((snapshot) => {
        const product = snapshot.val();
        if (!product) {
          alert("Producto no encontrado.");
          return;
        }

        const currentFrontStock = parseInt(
          document.getElementById(`stock-${id}`).textContent,
          10
        );

        if (currentFrontStock >= quantity) {
          const existingProduct = cart.find(item => item.id === id);
          if (existingProduct) {
            existingProduct.quantity += quantity;
          } else {
            cart.push({ ...product, id, quantity });
          }

          const newStock = currentFrontStock - quantity;
          updateProductStockInFrontend(id, newStock);
          updateCartDisplay();
        } else {
          alert(`No hay suficiente stock para el producto ${product.name}. Solo hay ${currentFrontStock} disponibles.`);
        }
      }).catch((error) => {
        console.error("Error obteniendo producto:", error);
      });
    }

    // Eliminar del carrito
    function removeFromCart(id) {
      const productToRemove = cart.find(item => item.id === id);
      if (!productToRemove) return;

      const stockElement = document.getElementById(`stock-${id}`);
      if (stockElement) {
        const currentStock = parseInt(stockElement.textContent, 10);
        const newStock = currentStock + productToRemove.quantity;
        stockElement.textContent = newStock;

        if (allProducts[id]) {
          allProducts[id].stock = newStock;
        }
      }

      cart = cart.filter(item => item.id !== id);
      updateCartDisplay();
    }

    function updateProductStockInFrontend(id, newStock) {
      const stockElement = document.getElementById(`stock-${id}`);
      if (stockElement) stockElement.textContent = newStock;
      if (allProducts[id]) allProducts[id].stock = newStock;
    }

    // Mostrar carrito
    function updateCartDisplay() {
      const cartContainer = document.getElementById("cart-list");
      if (!cartContainer) return;
      cartContainer.innerHTML = "";

      cart.forEach(item => {
        const li = document.createElement("li");
        li.classList.add("cart-list-item");
        li.innerHTML = `
          <div class="cart-item">
            <div class="cart-main-row">
              <span class="cart-product-name">${item.name}</span>
              <span class="cart-product-total">$${item.price * item.quantity}</span>
            </div>
            <p class="cart-qty"><strong>Cantidad:</strong> ${item.quantity}</p>
            <button type="button" onclick="removeFromCart('${item.id}')">Eliminar</button>
          </div>
        `;
        cartContainer.appendChild(li);
      });

      const totalElement = document.getElementById("cart-total");
      if (totalElement) totalElement.textContent = `Total: $${getCartTotal()}`;

      const cartCountEl = document.getElementById("cart-count");
      if (cartCountEl) {
        const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);
        cartCountEl.textContent = totalItems;
      }
    }

    function getCartTotal() {
      return cart.reduce((total, item) => total + item.price * item.quantity, 0);
    }

    // Checkout: asociar compra a cliente por correo
    async function checkout() {
      try {
        if (cart.length === 0) {
          alert("El carrito est√° vac√≠o.");
          return;
        }

        const emailInput = document.getElementById("client-email");
        const clientEmail = emailInput ? emailInput.value.trim() : "";

        if (!clientEmail) {
          alert("Debes ingresar el correo del cliente para registrar la venta.");
          return;
        }

        // Buscar cliente por correo en la rama 'clientes'
        const clientesRef = ref(database, "clientes");
        const clientesSnap = await get(clientesRef);

        if (!clientesSnap.exists()) {
          alert("No hay clientes registrados. Pide al cliente que se registre primero.");
          return;
        }

        const clientes = clientesSnap.val();
        let clientUid = null;

        for (const uid in clientes) {
          const c = clientes[uid];
          if (c && c.email && c.email.toLowerCase() === clientEmail.toLowerCase()) {
            clientUid = uid;
            break;
          }
        }

        if (!clientUid) {
          alert(
            "Este correo no est√° registrado como cliente.\n\n" +
            "Pide al cliente que se registre primero en la p√°gina de registro " +
            "para poder asociar la compra a su cuenta y que aparezca en su historial."
          );
          return;
        }

        const purchaseCode = generatePurchaseCode();
        const purchaseData = {
          code: purchaseCode,
          items: cart.map(item => ({
            name: item.name,
            quantity: item.quantity,
            price: item.price
          })),
          total: getCartTotal(),
          date: new Date().toISOString(),
          userId: clientUid,
          clientEmail: clientEmail
        };

        const purchaseRef = ref(database, "compras/" + purchaseCode);
        await set(purchaseRef, purchaseData);

        alert(`Compra realizada con √©xito.\nC√≥digo de compra: ${purchaseCode}`);

        const codeElement = document.getElementById("purchase-code");
        if (codeElement) {
          codeElement.textContent = `C√≥digo de compra: ${purchaseCode}`;
        }

        // Actualizar stock real en la base de datos
        for (const item of cart) {
          const dbRef = ref(database, "productos/" + item.id);
          try {
            const snapshot = await get(dbRef);
            const product = snapshot.val();
            if (product) {
              const newStock = (product.stock || 0) - item.quantity;
              await update(dbRef, { stock: newStock });
            }
          } catch (error) {
            console.error(`Error al actualizar el stock de ${item.name}:`, error);
          }
        }

        cart = [];
        updateCartDisplay();
        if (emailInput) emailInput.value = "";
        loadProducts();
      } catch (error) {
        console.error("Error al realizar la compra:", error);
        alert("Ocurri√≥ un error al registrar la venta. Revisa la consola para m√°s detalles.");
      }
    }

    function generatePurchaseCode() {
      return Math.floor(Math.random() * 10000)
        .toString()
        .padStart(4, "0");
    }

    function clearCartForm() {
      const cartList = document.getElementById("cart-list");
      const totalElement = document.getElementById("cart-total");
      const cartCountEl = document.getElementById("cart-count");
      const emailInput = document.getElementById("client-email");

      if (cartList) cartList.innerHTML = "";
      if (totalElement) totalElement.textContent = "Total: $0";
      if (cartCountEl) cartCountEl.textContent = "0";
      if (emailInput) emailInput.value = "";
    }

    // Filtros
    function setupFilters() {
      const searchInput = document.getElementById("product-search-emp");
      const sortSelect = document.getElementById("product-sort-emp");

      if (searchInput) {
        searchInput.addEventListener("input", () => {
          currentSearch = searchInput.value;
          renderProducts();
        });
      }

      if (sortSelect) {
        sortSelect.addEventListener("change", () => {
          currentSort = sortSelect.value;
          renderProducts();
        });
      }
    }

    function clearFilters() {
      const searchInput = document.getElementById("product-search-emp");
      const sortSelect = document.getElementById("product-sort-emp");

      currentSearch = "";
      currentSort = "default";

      if (searchInput) searchInput.value = "";
      if (sortSelect) sortSelect.value = "default";

      renderProducts();
    }

    // Logout
    function logout() {
      signOut(auth)
        .then(() => {
          window.location.href = "../login&registro.html";
        })
        .catch((err) => {
          console.error("Error al cerrar sesi√≥n:", err);
          window.location.href = "../login&registro.html";
        });
    }

    // Scope global
    window.addToCart = addToCart;
    window.removeFromCart = removeFromCart;
    window.checkout = checkout;
    window.logout = logout;
    window.clearFilters = clearFilters;

    // Inicio
    window.addEventListener("DOMContentLoaded", () => {
      loadProducts();
      initNav();
      setupFilters();
    });

    // Navegaci√≥n de vistas
    function initNav() {
      const navItems = document.querySelectorAll(".nav-item");
      const views = document.querySelectorAll(".view");

      navItems.forEach(item => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const target = item.dataset.view;
          if (!target) return;

          navItems.forEach(i => i.classList.remove("active"));
          item.classList.add("active");

          views.forEach(v => {
            if (v.id === "view-" + target) {
              v.classList.add("active-view");
            } else {
              v.classList.remove("active-view");
            }
          });
        });
      });
    }
  </script>

  <style>
    #product-list {
      list-style: none;
      padding: 0;
      margin: 0;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background-color: #020617;
      overflow: hidden;
    }

    .product-list-item {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      background-color: #020617;
    }

    .product-list-item:last-child {
      border-bottom: none;
    }

    .product-list-item:hover {
      background-color: #0b1120;
    }

    .product-info {
      flex: 1;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .product-main-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .product-name {
      font-weight: 600;
      color: #e5e7eb;
    }

    .product-price {
      font-weight: 600;
      color: #fdc62d;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    .product-description {
      font-size: 0.85rem;
      color: #cbd5f5;
    }

    .product-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      font-size: 0.8rem;
    }

    .product-qty label {
      margin-right: 4px;
    }

    .product-qty input[type="number"] {
      width: 80px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background-color: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      outline: none;
    }

    .product-qty input[type="number"]:focus {
      border-color: #fdc62d;
    }

    .button-container {
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .button-container button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background-color: #fdc62d;
      color: #111827;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: background-color 0.3s ease, transform 0.2s;
      white-space: nowrap;
    }

    .button-container button:hover {
      background-color: #f97316;
      transform: translateY(-1px);
    }

    .tables-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    #product-search-emp,
    #product-sort-emp {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background-color: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      outline: none;
    }

    #product-search-emp {
      flex: 1 1 220px;
    }

    #product-sort-emp {
      flex: 0 0 210px;
    }

    #product-search-emp::placeholder {
      color: #9ca3af;
    }

    #cart-list {
      list-style: none;
      padding: 0;
      margin: 0;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background-color: #020617;
      overflow: hidden;
    }

    .cart-list-item {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .cart-list-item:last-child {
      border-bottom: none;
    }

    .cart-item {
      font-size: 0.9rem;
    }

    .cart-main-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .cart-product-name {
      font-weight: 600;
      color: #e5e7eb;
    }

    .cart-product-total {
      font-weight: 600;
      color: #fdc62d;
    }

    .cart-qty {
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .cart-item button {
      padding: 5px 10px;
      border-radius: 999px;
      border: none;
      background-color: #fdc62d;
      color: #111827;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background-color 0.3s ease, transform 0.2s;
    }

    .cart-item button:hover {
      background-color: #f97316;
      transform: translateY(-1px);
    }

    #cart-total {
      font-size: 1rem;
      font-weight: 700;
      margin-top: 10px;
      text-align: right;
      color: #fdc62d;
    }

    .checkout-container {
      text-align: right;
      margin-top: 12px;
    }

    .checkout-container button {
      display: inline-block;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background-color: #fdc62d;
      color: #111827;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s ease, transform 0.2s;
    }

    .checkout-container button:hover {
      background-color: #f97316;
      transform: translateY(-1px);
    }

    #purchase-code {
      color: #fdc62d;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .client-email-field {
      margin-top: 10px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .client-email-field label {
      font-size: 0.85rem;
      color: #cbd5f5;
    }

    .client-email-field input[type="email"] {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.45);
      background-color: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      outline: none;
    }

    .client-email-field input[type="email"]::placeholder {
      color: #9ca3af;
    }

    @media (max-width: 900px) {
      .product-meta-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="avatar-circle" id="sidebar-avatar">E</div>
        <div class="user-info">
          <p class="user-name" id="sidebar-name">Empleado</p>
          <p class="user-role">Panel de empleado</p>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-view="inicio">
          <span class="nav-icon">üè†</span><span>Inicio</span>
        </a>
        <a href="#" class="nav-item" data-view="productos">
          <span class="nav-icon">üì¶</span><span>Productos</span>
        </a>
        <a href="#" class="nav-item" data-view="carrito">
          <span class="nav-icon">üõí</span><span>Carrito</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <small>¬© 2025 Muebles Concepci√≥n a Medida</small>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <div>
          <h1 class="page-title">Panel de Empleado</h1>
          <p class="page-subtitle">Registra ventas y gestiona el carrito de productos.</p>
        </div>

        <div class="top-bar">
          <button class="btn-login" onclick="window.location.href='../index.html'">Inicio</button>
          <button class="btn-login" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
      </header>

      <div id="view-inicio" class="view active-view">
        <section class="section">
          <div class="summary-grid">
            <div class="summary-card">
              <h3>Empleado</h3>
              <p class="summary-number">1</p>
              <span class="summary-label">Sesi√≥n activa</span>
            </div>
            <div class="summary-card">
              <h3>Productos</h3>
              <p class="summary-number" id="products-count">0</p>
              <span class="summary-label">Productos disponibles</span>
            </div>
            <div class="summary-card">
              <h3>Carrito</h3>
              <p class="summary-number" id="cart-count">0</p>
              <span class="summary-label">Unidades en carrito</span>
            </div>
          </div>
        </section>

        <section class="section">
          <div class="card">
            <p class="section-description">
              Desde este panel puedes revisar el listado de productos, armar un carrito y registrar la venta en Firebase.
            </p>
          </div>
        </section>
      </div>

      <div id="view-productos" class="view">
        <section class="section">
          <div class="card">
            <h2>Lista de productos</h2>
            <p class="section-description">
              Selecciona la cantidad que el cliente desea y agr√©gala al carrito.
            </p>

            <div class="tables-header">
              <input
                type="text"
                id="product-search-emp"
                placeholder="Buscar por nombre o descripci√≥n"
              >
              <select id="product-sort-emp">
                <option value="default">Orden original</option>
                <option value="stock-desc">M√°s stock primero</option>
                <option value="stock-asc">Menos stock primero</option>
                <option value="name-asc">Nombre A ‚Üí Z</option>
                <option value="name-desc">Nombre Z ‚Üí A</option>
              </select>
              <button type="button" class="btn-outline" onclick="clearFilters()">Limpiar</button>
            </div>

            <ul id="product-list">
            </ul>
          </div>
        </section>
      </div>

      <div id="view-carrito" class="view">
        <section class="section">
          <div class="card">
            <h2>Carrito de compras</h2>
            <p class="section-description">
              Revisa los productos agregados y asocia la venta a un cliente registrado por su correo.
            </p>

            <div class="client-email-field">
              <label for="client-email">Correo del cliente (registrado como cliente):</label>
              <input
                type="email"
                id="client-email"
                placeholder="correo@cliente.com"
              >
            </div>

            <ul id="cart-list">
            </ul>

            <p id="cart-total">Total: $0</p>

            <div class="checkout-container">
              <button onclick="checkout()">Realizar venta</button>
            </div>

            <h3 id="purchase-code"></h3>
          </div>
        </section>
      </div>
    </main>
  </div>
</body>
</html>
