<!DOCTYPE html>
<html lang="es">
<head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Login y Registro</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Botón para volver a la página de inicio -->
  <button class="back-button" onclick="window.location.href='../index.html'">
    ⬅ Volver a Inicio
  </button>

  <div class="auth-container">
    <!-- Sección de Login -->
    <div id="loginSection" class="auth-card" style="display:none;">
      <h2 class="title">Iniciar sesión</h2>
      <form id="loginForm" class="auth-form">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Contraseña" required>
        <button type="submit" class="primary-btn">Iniciar sesión</button>
      </form>
      <p class="switch-text">
        ¿No tienes cuenta?
        <a href="#" id="registerLink">Regístrate</a>
      </p>
      <p id="loginMessage" class="message"></p>
    </div>
    
    <!-- Sección de Registro -->
    <div id="registerSection" class="auth-card" style="display:block;">
      <h2 class="title">Registro</h2>
      <form id="registerForm" class="auth-form">
        <input type="email" id="registerEmail" placeholder="Email" required>
        <input type="password" id="registerPassword" placeholder="Contraseña" required>
        <input type="password" id="confirmPassword" placeholder="Confirmar contraseña" required>
        <select id="registerUserType" required>
          <!-- <option value="admins">Administrador</option> -->
          <option value="empleados">Empleado</option>
          <option value="clientes">Cliente</option>
          
        </select>
        <button type="submit" class="primary-btn">Registrar</button>
      </form>
      <p class="switch-text">
        ¿Ya tienes cuenta?
        <a href="#" id="loginLink">Inicia sesión</a>
      </p>
      <p id="registerMessage" class="message"></p>
    </div>
  </div>

  <!-- Script Firebase y lógica de login/registro -->
  <script type="module">
    // Importes desde CDN (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      child 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // NUEVA CONFIGURACIÓN FIREBASE
    const firebaseConfig = { 
      apiKey: "AIzaSyAthW2iuNy8SGUOVCzhjqEuDOIjWoDpi_A", 
      authDomain: "crud-7fb63.firebaseapp.com", 
      databaseURL: "https://crud-7fb63-default-rtdb.firebaseio.com", 
      projectId: "crud-7fb63", 
      storageBucket: "crud-7fb63.firebasestorage.app", 
      messagingSenderId: "449296123494", 
      appId: "1:449296123494:web:ad23ebf3e3b695ee62cfa7" 
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Helpers UI
    function showMessage(elementId, text, type = "info") {
      const el = document.getElementById(elementId);
      el.textContent = text;
      el.className = `message ${type}`;
    }

    function clearForm(formId) {
      const form = document.getElementById(formId);
      if (form) form.reset();
    }

    function toggleRegister() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('registerSection').style.display = 'block';
      showMessage("loginMessage", "");
      showMessage("registerMessage", "");
    }

    function toggleLogin() {
      document.getElementById('registerSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      showMessage("loginMessage", "");
      showMessage("registerMessage", "");
    }

    // Registro de usuario (FUNCIÓN MODIFICADA)
    async function registerUser(email, password, userType) {
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const userId = user.uid;

        const userRef = ref(database, `${userType}/${userId}`);
        await set(userRef, {
          email: email,
          createdAt: new Date().toISOString()
        });

        showMessage("registerMessage", "Usuario registrado correctamente ✅", "success");
        clearForm("registerForm");

        // Pasar a login después de un momento
        setTimeout(() => {
          toggleLogin();
        }, 1000);

      } catch (error) {
        console.error("Error en el registro:", error);

        let msg = "Error al registrar.";

        // Manejo de errores específicos
        if (error.code === "auth/email-already-in-use") {
          msg = "Este correo ya está registrado. Inicia sesión en lugar de registrarte.";
        } else if (error.code === "auth/invalid-email") {
          msg = "El correo no tiene un formato válido.";
        } else if (error.code === "auth/weak-password") {
          msg = "La contraseña es muy débil. Usa al menos 6 caracteres.";
        } else {
          msg = "Ocurrió un error al registrar: " + error.message;
        }

        showMessage("registerMessage", msg, "error");
      }
    }

    // Login de usuario (puedes dejarlo igual, solo le mejoramos el mensaje genérico)
    async function loginUser(email, password) {
      try {
        showMessage("loginMessage", "Iniciando sesión...", "info");
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const userId = user.uid;

        const categories = ["admins", "empleados", "clientes"];
        const dbRef = ref(database);
        let userCategory = null;

        for (const category of categories) {
          const snap = await get(child(dbRef, `${category}/${userId}`));
          if (snap.exists()) {
            userCategory = category;
            break;
          }
        }

        if (!userCategory) {
          showMessage("loginMessage", "Usuario sin categoría asignada en la base de datos.", "error");
          return;
        }

        showMessage("loginMessage", "Inicio de sesión exitoso ✅", "success");
        clearForm("loginForm");

        if (userCategory === "admins") {
          window.location.href = "admin.html";
        } else if (userCategory === "empleados") {
          window.location.href = "empleado_dashboard.html";
        } else if (userCategory === "clientes") {
          window.location.href = "cliente_dashboard.html";
        }
      } catch (error) {
        console.error("Error al iniciar sesión:", error);

        let msg = "Error al iniciar sesión.";

        if (error.code === "auth/user-not-found") {
          msg = "No existe un usuario con ese correo.";
        } else if (error.code === "auth/wrong-password") {
          msg = "Contraseña incorrecta.";
        } else if (error.code === "auth/invalid-email") {
          msg = "El correo no tiene un formato válido.";
        } else {
          msg = "Ocurrió un error al iniciar sesión: " + error.message;
        }

        showMessage("loginMessage", msg, "error");
      }
    }

    // Configurar eventos cuando el DOM está listo
    document.addEventListener("DOMContentLoaded", () => {
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const registerLink = document.getElementById("registerLink");
      const loginLink = document.getElementById("loginLink");

      // Mostrar Registro por defecto
      toggleRegister();

      registerLink.addEventListener("click", (e) => {
        e.preventDefault();
        toggleRegister();
      });

      loginLink.addEventListener("click", (e) => {
        e.preventDefault();
        toggleLogin();
      });

      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();

        if (!email || !password) {
          showMessage("loginMessage", "Completa todos los campos.", "error");
          return;
        }
        loginUser(email, password);
      });

      registerForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const email = document.getElementById("registerEmail").value.trim();
        const password = document.getElementById("registerPassword").value.trim();
        const confirmPassword = document.getElementById("confirmPassword").value.trim();
        const userType = document.getElementById("registerUserType").value;

        if (!email || !password || !confirmPassword || !userType) {
          showMessage("registerMessage", "Completa todos los campos.", "error");
          return;
        }

        if (password !== confirmPassword) {
          showMessage("registerMessage", "Las contraseñas no coinciden.", "error");
          return;
        }

        if (password.length < 6) {
          showMessage("registerMessage", "La contraseña debe tener al menos 6 caracteres.", "error");
          return;
        }

        registerUser(email, password, userType);
      });
    });
  </script>
</body> 
</html>
