<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="empleados.css">
  <title>Interfaz de Empleado</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGagpgCaZPtv3rrQVpiPLSUJzI3sJogGg",
      authDomain: "crud-18998.firebaseapp.com",
      projectId: "crud-18998",
      storageBucket: "crud-18998.firebasestorage.app",
      messagingSenderId: "1046471634199",
      appId: "1:1046471634199:web:37309d7fd8825896755b52"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    let isLoggingOut = false;

    function loadProducts() {
      const productsRef = ref(database, 'productos');
      get(productsRef)
        .then((snapshot) => {
          if (snapshot.exists()) {
            const products = snapshot.val();
            let productsHtml = '';
            for (const key in products) {
              if (products.hasOwnProperty(key)) {
                const product = products[key];
                productsHtml += `
                  <div class="product-card">
                    <h3>${product.nombre}</h3>
                    <p class="product-price">$${product.precio}</p>
                    <p class="product-description">${product.descripcion}</p>
                  </div>
                `;
              }
            }
            document.getElementById('productsList').innerHTML = productsHtml;
          } else {
            document.getElementById('productsList').innerHTML = '<p>No hay productos disponibles.</p>';
          }
        })
        .catch((error) => {
          console.error('Error al cargar productos:', error);
        });
    }

    function loadEmployeeInfo() {
      const user = auth.currentUser;
      if (user) {
        document.getElementById('employeeEmail').innerText = `Email: ${user.email}`;
        const userRef = ref(database, `empleados/${user.uid}`);
        get(userRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              const empleado = snapshot.val();
              document.getElementById('employeeRole').innerText = `Rol: ${empleado.userType}`;
            }
          })
          .catch((error) => {
            console.error('Error al obtener información del empleado:', error);
          });
      }
    }

    function logout() {
      isLoggingOut = true;
      signOut(auth)
        .then(() => {
          alert('Has cerrado sesión correctamente.');
          window.location.href = 'login.html';
        })
        .catch((error) => {
          console.error('Error al cerrar sesión:', error);
          alert('Ocurrió un error al intentar cerrar sesión.');
          isLoggingOut = false;
        });
    }

    window.addEventListener('load', () => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          if (!isLoggingOut) {
            loadEmployeeInfo();
            loadProducts();
          }
        } else {
          if (!isLoggingOut) {
            alert('No estás autenticado. Redirigiendo a la página de login...');
            window.location.href = 'login.html';
          }
        }
      });

      document.getElementById('logoutButton').addEventListener('click', logout);
    });
  </script>
</head>
<body>
  <header>
    <div class="header-container">
      <h2>Bienvenido, Empleado</h2>
    </div>
  </header>
  <main>
    <div class="employee-info">
      <p id="employeeEmail"></p>
      <p id="employeeRole"></p>
      <button id="logoutButton" class="logout-btn">Cerrar sesión</button>
    </div>

    <section>
      <h3>Productos Disponibles</h3>
      <div id="productsList" class="products-container">
        <!-- Aquí se cargarán los productos desde Firebase -->
      </div>
    </section>
  </main>
</body>
</html>
